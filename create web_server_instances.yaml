- name: create a disk
  google.cloud.gcp_compute_disk:
      name: 'disk-{{ instance_name }}'
      size_gb: 10
      source_image: "{{ image }}"
      zone: "{{ zone }}"
      project: "{{ gcp_project }}"
      auth_kind: "machineaccount"
      credentials_file: "{{ gcp_cred_file }}"
      service_account_email: "{{ gcp_service_account_email }}"
      scopes: "{{ scopes }}"
      state: present
  register: disk

- name: create a address
  google.cloud.gcp_compute_address:
      name: 'address-{{ instance_name }}'
      region: "{{ region }}"
      project: "{{ gcp_project }}"
      auth_kind: "machineaccount"
      credentials_file: "{{ gcp_cred_file }}"
      service_account_email: "{{ gcp_service_account_email }}"
      scopes: "{{ scopes }}"
      state: present
  register: address

- name: create instance
  google.cloud.gcp_compute_instance:
      state: present
      name: "{{ instance_name }}"
      machine_type: "{{ machine_type }}"
      disks:
        - auto_delete: true
          boot: true
          source: "{{ disk }}"
      network_interfaces:
          - network: null # use default
            access_configs:
              - name: 'External NAT'
                nat_ip: "{{ address }}"
                type: 'ONE_TO_ONE_NAT'
      zone: "{{ zone }}"
      project: "{{ gcp_project }}"
      auth_kind: "machineaccount"
      credentials_file: "{{ gcp_cred_file }}"
      service_account_email: "{{ gcp_service_account_email }}"
      scopes: "{{ scopes }}"
  register: db_deploy_result
